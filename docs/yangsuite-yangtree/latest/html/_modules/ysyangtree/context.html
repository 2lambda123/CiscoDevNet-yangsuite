

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ysyangtree.context &mdash; yangsuite-yangtree 1.19.1.post0.dev3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> yangsuite-yangtree
          

          
          </a>

          
            
            
              <div class="version">
                1.19.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">Working with YANG Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">ysyangtree developer documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">yangsuite-yangtree</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ysyangtree.context</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ysyangtree.context</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Context for YANG model parsing and result streams.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">pyang</span>
<span class="kn">from</span> <span class="nn">pyang</span> <span class="kn">import</span> <span class="n">error</span> <span class="k">as</span> <span class="n">pyang_err</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ymodels</span>
<span class="kn">from</span> <span class="nn">yangsuite</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">yangsuite.paths</span> <span class="kn">import</span> <span class="n">get_base_path</span>
<span class="kn">from</span> <span class="nn">ysfilemanager</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">YSYangSet</span><span class="p">,</span> <span class="n">name_and_revision_from_file</span><span class="p">,</span> <span class="n">split_user_set</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">parseyang</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_parse_yang"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.get_parse_yang">[docs]</a><span class="k">def</span> <span class="nf">get_parse_yang</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the ParseYang instance associated with the given user.</span>

<span class="sd">    Args:</span>
<span class="sd">      user (str): Username to look up. TODO: rename to &#39;index&#39; or &#39;key&#39;</span>
<span class="sd">    Returns:</span>
<span class="sd">      ymodels.ParseYang: instance, or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">parseyang</span>
    <span class="n">psy</span> <span class="o">=</span> <span class="n">parseyang</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">return</span> <span class="n">psy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parseyang&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="reset_parse_yang"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.reset_parse_yang">[docs]</a><span class="k">def</span> <span class="nf">reset_parse_yang</span><span class="p">(</span><span class="n">yp</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the ParseYang instance associated with the given user.</span>

<span class="sd">    Args:</span>
<span class="sd">      yp (ymodels.ParseYang): Instance to set</span>
<span class="sd">      user (str): Username to set yp for. TODO: rename to &#39;index&#39; or &#39;key&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yp</span><span class="p">,</span> <span class="n">ymodels</span><span class="o">.</span><span class="n">ParseYang</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected ParseYang instance, got </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yp</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">parseyang</span>
    <span class="n">psy</span> <span class="o">=</span> <span class="n">parseyang</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">psy</span><span class="p">[</span><span class="s1">&#39;parseyang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yp</span>
    <span class="n">parseyang</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">psy</span></div>


<div class="viewcode-block" id="get_result_stream"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.get_result_stream">[docs]</a><span class="k">def</span> <span class="nf">get_result_stream</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create or retrieve from cache a StringIO instance for the given user.</span>

<span class="sd">    Args:</span>
<span class="sd">      user (str): Key to locate/store the desired results stream.</span>
<span class="sd">        TODO: rename to &#39;index&#39; or &#39;key&#39;</span>
<span class="sd">    Returns:</span>
<span class="sd">      io.StringIO: Results stream object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">parseyang</span>
    <span class="n">psy</span> <span class="o">=</span> <span class="n">parseyang</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="n">deque</span><span class="p">())</span>
    <span class="n">psy</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
    <span class="n">parseyang</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">psy</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="set_result_stream"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.set_result_stream">[docs]</a><span class="k">def</span> <span class="nf">set_result_stream</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set result stream with your own logger.</span>

<span class="sd">    Args:</span>
<span class="sd">      key (str): Index to set result to.</span>
<span class="sd">      log (object):</span>
<span class="sd">        Class that provides results.</span>
<span class="sd">        Object must have these functions::</span>

<span class="sd">            __len__ : Returns length of result queue.</span>
<span class="sd">            popleft : Returns next message in queue to process.</span>
<span class="sd">            append  : Set new message at proper location in queue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">parseyang</span>
    <span class="n">psy</span> <span class="o">=</span> <span class="n">parseyang</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">psy</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span>
    <span class="n">parseyang</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">psy</span></div>


<div class="viewcode-block" id="reset_result_stream"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.reset_result_stream">[docs]</a><span class="k">def</span> <span class="nf">reset_result_stream</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TODO: rename user to &#39;index&#39; or &#39;key&#39;.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">parseyang</span>
    <span class="n">psy</span> <span class="o">=</span> <span class="n">parseyang</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psy</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="n">parseyang</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">psy</span></div>


<div class="viewcode-block" id="YSContext"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext">[docs]</a><span class="k">class</span> <span class="nc">YSContext</span><span class="p">(</span><span class="n">pyang</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extend pyang.Context with a few useful features.</span>

<span class="sd">    .. automethod:: __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="YSContext.get_instance"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.get_instance">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">yangset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve cached YSContext instance or create a new one.</span>

<span class="sd">        First call to this method instantiates a YSContext and caches it in</span>
<span class="sd">        shared storage using yangset name as the index.  The clients may not</span>
<span class="sd">        want to block it&#39;s execution waiting for it to finish building, thus,</span>
<span class="sd">        multiple calls for the same yangset context may occur and each client</span>
<span class="sd">        can begin to use the context when load status is set to &quot;ready&quot;.</span>

<span class="sd">        Args:</span>
<span class="sd">          ref (object): Label identifying caller that will use the context.</span>
<span class="sd">          yangset (str): YANG set owner+name also used as index for storage in</span>
<span class="sd">                         the cache.</span>

<span class="sd">            1. if no cached context exists, create a new one and store it</span>
<span class="sd">               with a reference.</span>

<span class="sd">            2. if a cached context is available, but the associated yangset</span>
<span class="sd">               has changed, discard it from the cache and create a new one.</span>

<span class="sd">        Returns:</span>
<span class="sd">          YSContext: Cached YSContext, or None.</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError: if &#39;yangset&#39; is an improperly formed string</span>
<span class="sd">          OSError: if the requested YANG set doesn&#39;t exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yangset</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using private context.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_private_instance</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">yangset</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">owner</span><span class="p">,</span> <span class="n">setname</span> <span class="o">=</span> <span class="n">split_user_set</span><span class="p">(</span><span class="n">yangset</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">YSYangSet</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">setname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>

            <span class="n">repo</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">repository</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">YSYangSet</span><span class="p">):</span>
                <span class="c1"># Not a yangset - how&#39;d we get here?</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cached context for </span><span class="si">%s</span><span class="s2"> has a non-YSYangSet &quot;</span>
                            <span class="s2">&quot;repository?&quot;</span><span class="p">,</span> <span class="n">yangset</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">discard_instance</span><span class="p">(</span><span class="n">yangset</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">ys</span> <span class="o">==</span> <span class="n">repo</span><span class="p">:</span>   <span class="c1"># YSYangSet may be missing __ne__ logic.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding cached context for </span><span class="si">%s</span><span class="s2"> due to change of &quot;</span>
                         <span class="s2">&quot;YANG set from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">yangset</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">discard_instance</span><span class="p">(</span><span class="n">yangset</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_stale</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding cached context for </span><span class="si">%s</span><span class="s2"> as its view of the &quot;</span>
                         <span class="s2">&quot;repository contents is stale&quot;</span><span class="p">,</span> <span class="n">yangset</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">discard_instance</span><span class="p">(</span><span class="n">yangset</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cached ctx has same yangset&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">yangset</span><span class="p">,</span> <span class="p">[],</span> <span class="n">ref</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ctx</span><span class="o">.</span><span class="n">ready</span>

        <span class="k">return</span> <span class="n">ctx</span></div>

<div class="viewcode-block" id="YSContext.get_private_instance"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.get_private_instance">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_private_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">yangset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve cached YSContext instance or create a new one.</span>

<span class="sd">        First call to this method instantiates a YSContext and caches it in</span>
<span class="sd">        private storate using key as the index.  The clients may not</span>
<span class="sd">        want to block it&#39;s execution waiting for it to finish building, thus,</span>
<span class="sd">        multiple calls for the same yangset context may occur and each client</span>
<span class="sd">        can begin to use the context when load status is set to &quot;ready&quot;.</span>

<span class="sd">        Args:</span>
<span class="sd">          key (str): index to private context</span>
<span class="sd">          yangset (str): YANG set owner+name.</span>

<span class="sd">            1. if no cached context exists, create a new one and store it</span>
<span class="sd">               at key index.</span>

<span class="sd">            2. if a cached context is available, but the associated yangset</span>
<span class="sd">               has changed, discard it from the cache and create a new one.</span>

<span class="sd">        Returns:</span>
<span class="sd">          YSContext: Cached YSContext, or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">yangset</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span>

        <span class="n">owner</span><span class="p">,</span> <span class="n">setname</span> <span class="o">=</span> <span class="n">split_user_set</span><span class="p">(</span><span class="n">yangset</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">YSYangSet</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">setname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">repository</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">YSYangSet</span><span class="p">):</span>
                <span class="c1"># Not a yangset - how&#39;d we get here?</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cached context for </span><span class="si">%s</span><span class="s2"> has a non-YSYangSet &quot;</span>
                            <span class="s2">&quot;repository?&quot;</span><span class="p">,</span> <span class="n">yangset</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">discard_instance</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">ys</span> <span class="o">==</span> <span class="n">repo</span><span class="p">:</span>   <span class="c1"># YSYangSet may be missing __ne__ logic.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding cached context for </span><span class="si">%s</span><span class="s2"> due to change of &quot;</span>
                         <span class="s2">&quot;YANG set from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">discard_instance</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_stale</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding cached context for </span><span class="si">%s</span><span class="s2"> as its view of the &quot;</span>
                         <span class="s2">&quot;repository contents is stale&quot;</span><span class="p">,</span> <span class="n">yangset</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">discard_instance</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cached ctx has same key&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">assert</span> <span class="n">ctx</span><span class="o">.</span><span class="n">ready</span>

        <span class="k">return</span> <span class="n">ctx</span></div>

<div class="viewcode-block" id="YSContext.discard_instance"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.discard_instance">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">discard_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forget about the given instance if all references have been removed.</span>

<span class="sd">        Args:</span>
<span class="sd">          key (str): index of YSContext to discard</span>
<span class="sd">          ref (object): Reference to shared context (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check cached context reference </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reference</span> <span class="ow">and</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cached context dereferenced </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">reference</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding context </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarding context </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cached instance not found, key </span><span class="si">%s</span><span class="s1"> ref </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span></div>

<div class="viewcode-block" id="YSContext.__init__"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_repo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modulenames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate and begin loading the module(s) from the repository.</span>

<span class="sd">        - If caller does not send a key, the context is not cached.</span>
<span class="sd">        - If caller sends a key but no ref, context is cached and first call</span>
<span class="sd">          to discard_reference with the correct key will remove the context.</span>
<span class="sd">        - If caller sends both key and ref, the context is considered shared</span>
<span class="sd">          and cannot be discarded until all references are removed.</span>

<span class="sd">        :meth:`get_instance` handles shared case.</span>
<span class="sd">        :meth:`get_private_instance` handles not shared case.</span>
<span class="sd">        :meth:`discard_instance` used for both shared and private.</span>

<span class="sd">        Caller responsible for calling :meth:`discard_instance`.</span>

<span class="sd">        Args:</span>
<span class="sd">          path_or_repo (str): Path to directory containing YANG files **OR**</span>
<span class="sd">            path to JSON file describing a YSYangSet **OR**</span>
<span class="sd">            an instance of pyang.Repository or subclass (including YSYangSet)</span>
<span class="sd">          key (str): Optional key to cache this YSContext for later use with</span>
<span class="sd">            :meth:`get_instance` (if ref is usedU :meth:`get_private_instance`</span>
<span class="sd">            (if no ref is used).</span>
<span class="sd">          modulenames (list): Name(s) of module(s) to load (along with their</span>
<span class="sd">            dependencies). If unspecified, the legacy behavior of loading</span>
<span class="sd">            all modules in the repository is preserved, but is not recommended</span>
<span class="sd">            due to memory usage concerns. To create a YSContext but defer</span>
<span class="sd">            loading any modules, pass an empty list for this parameter.</span>
<span class="sd">          ref (object): Optional reference to be used in conjunction with the</span>
<span class="sd">            key. The key is used to find the cached context and each ref added</span>
<span class="sd">            signifies an active user of the context, so, each call to</span>
<span class="sd">            :meth:`discard_instance` will remove the ref only until all ref</span>
<span class="sd">            have been removed, then discard the context.</span>

<span class="sd">        Raises:</span>
<span class="sd">          OSError: if path does not exist or is otherwise invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_or_repo</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must specify a path or a YSYangSet instance&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing context for path &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">path_or_repo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">YSContext</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Context stored with reference &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Context not stored&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ready&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="s1">&#39;initializing...&#39;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">,</span> <span class="n">pyang</span><span class="o">.</span><span class="n">Repository</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">YSContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">)):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">YSContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">pyang</span><span class="o">.</span><span class="n">FileRepository</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">),</span> <span class="n">use_env</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">YSContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">YSYangSet</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identities</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dict mapping identity arg strings to corresponding Statements.</span>

<span class="sd">        Aggregate of the ``i_identities`` from each module loaded in this</span>
<span class="sd">        Context. Used to construct the :attr:`identities` dict once all</span>
<span class="sd">        modules have been loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">invalid_modules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of modules that were found but failed loading altogether.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">augmenters_of</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dict mapping modules to list of modules that (may) augment it.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identity_derivers_of</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dict: modules to list of modules that (may) derive identities.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">submodules_of</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dict: modules to list of submodules included in this module.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_module_files</span><span class="p">(</span><span class="n">modulenames</span><span class="p">)</span>
        <span class="c1"># Done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ready&#39;</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Context &#39;</span><span class="si">%s</span><span class="s2">&#39; now fully loaded and ready&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Context finished loading for &#39;</span><span class="si">%s</span><span class="s2">&#39;, now ready&quot;</span><span class="p">,</span>
                     <span class="n">path_or_repo</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation of a YSContext.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;YSContext (repository </span><span class="si">{0}</span><span class="s2">) with </span><span class="si">{1}</span><span class="s2"> modules loaded&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if YSContext finished loading all module files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="YSContext.get_module"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.get_module">[docs]</a>    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modulename</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the Statement corresponding to the given module.</span>

<span class="sd">        Args:</span>
<span class="sd">          modulename (str): Name of the module to request.</span>
<span class="sd">          revision (str): Specific revision to request. None or &#39;&#39; implies</span>
<span class="sd">            latest available revision.</span>
<span class="sd">        Returns:</span>
<span class="sd">          pyang.statements.Statement: or None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Context.get_module doesn&#39;t recognize revision=&#39;&#39; as synonymous</span>
        <span class="c1"># with revision=None, but we want to do so:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">revision</span><span class="p">:</span>
            <span class="n">revision</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">YSContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_module</span><span class="p">(</span><span class="n">modulename</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span></div>

<div class="viewcode-block" id="YSContext.get_yang_parser"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.get_yang_parser">[docs]</a>    <span class="k">def</span> <span class="nf">get_yang_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a ParseYang instance for the given module in this context.</span>

<span class="sd">        Args:</span>
<span class="sd">          name (str): YANG model name</span>
<span class="sd">          revision (str): YANG model revision, or None for latest available.</span>
<span class="sd">        Returns:</span>
<span class="sd">          ymodels.ParseYang: newly constructed instance.</span>
<span class="sd">        Raises:</span>
<span class="sd">          ValueError: see ParseYang.__init__()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ymodels</span><span class="o">.</span><span class="n">ParseYang</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="YSContext.load_module_files"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.load_module_files">[docs]</a>    <span class="k">def</span> <span class="nf">load_module_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modulenames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and parse the given module(s) and dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">          modulenames (list): YANG model name(s). If omitted (i.e. ``None``),</span>
<span class="sd">            all modules in the repository will be loaded.</span>
<span class="sd">            An empty list means to load no additional modules at this time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modulenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modules_to_load</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span>
                                  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">modulenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No module loading requested.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading module(s) </span><span class="si">%s</span><span class="s2"> from repository </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="n">modulenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="s1">&#39;modules_using&#39;</span><span class="p">):</span>
                <span class="c1"># Method on YSYangSet, but not on base pyang.Repository</span>
                <span class="n">modules_to_load</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">mn</span> <span class="ow">in</span> <span class="n">modulenames</span><span class="p">:</span>
                    <span class="n">modules_to_load</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">modules_using</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Will load upstream modules as well: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="nb">sorted</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">))</span>
                <span class="n">modules_to_load</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">modulenames</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modules_to_load</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">modulenames</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%d</span><span class="s2"> YANG modules. This may take some time &quot;</span>
                        <span class="s2">&quot;and consume significant amounts of system memory.&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_modules</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="s1">&#39;modules_augmenting&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Checking augmenters...&quot;</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">augmenters_of</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">modules_augmenting</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="s1">&#39;modules_deriving_identities_from&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Checking identity derivation...&quot;</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identity_derivers_of</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">modules_deriving_identities_from</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_derivers_of</span><span class="p">[</span><span class="n">mod</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found identity derivers of </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_derivers_of</span><span class="p">[</span><span class="n">mod</span><span class="p">])</span>

        <span class="c1"># Additionally, load identity derivers of ALL modules loaded thus far</span>
        <span class="c1"># (but not augmenters) to make sure we have the full set of identities.</span>
        <span class="n">extra_mods</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">derivers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_derivers_of</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">extra_mods</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">derivers</span><span class="p">)</span>
        <span class="n">extra_mods</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_mods</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> additional modules that derive identities: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">extra_mods</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extra_mods</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_modules</span><span class="p">(</span><span class="n">extra_mods</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">i_including_modulename</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">i_including_modulename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules_of</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">submodules_of</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="n">i_including_modulename</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submodules_of</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="n">i_including_modulename</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_identity_bases</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_load_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper to :meth:`load_module_files`.</span>

<span class="sd">        Actually load the given module list, without further evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">          module_list (list): List of module names to load, or None to load</span>
<span class="sd">            all available modules</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_list</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">modules</span>
        <span class="n">modules_to_load</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">module_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">)</span>
        <span class="n">deviations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">modules_loading</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="c1"># Each entry is something like:</span>
            <span class="c1"># (&#39;yang-types&#39;, &#39;20xx-mm-dd&#39;, &#39;/path/to/yang-types.yang&#39;)</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modules_to_load</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;deviation&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="c1"># Load deviations last</span>
                <span class="n">deviations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modules_loading</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">modules_loading</span> <span class="o">+</span> <span class="n">deviations</span><span class="p">:</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modules_to_load</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;parsing </span><span class="si">{0}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Calling get_module_from_handle() + add_module() *should*</span>
            <span class="c1"># be faster than calling search_module()</span>
            <span class="n">ref</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_module_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to load module </span><span class="si">%s</span><span class="s2"> due to &quot;</span>
                            <span class="s2">&quot;critical parsing errors&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">invalid_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully loaded </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="n">modules_to_load</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Was any module just not seen at all?</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">modules_to_load</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Module </span><span class="si">%s</span><span class="s2"> not found in the repository&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">!=</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]):</span>      <span class="c1"># pragma: no cover</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Possible internal error - count of modules processed &quot;</span>
                        <span class="s2">&quot;(</span><span class="si">%d</span><span class="s2">) does not match expected total (</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Have now loaded </span><span class="si">%d</span><span class="s2"> modules, of </span><span class="si">%d</span><span class="s2"> available in repository&quot;</span><span class="p">,</span>
                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">modules</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Module loading complete&quot;</span>

<div class="viewcode-block" id="YSContext.get_identity_bases"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.get_identity_bases">[docs]</a>    <span class="k">def</span> <span class="nf">get_identity_bases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the i_identities for all modules we have loaded.</span>

<span class="sd">        This function deals with built-in type &quot;identityref&quot;</span>
<span class="sd">        https://tools.ietf.org/html/rfc6020#section-9.10</span>

<span class="sd">        The identity statement can be defined in a YANG module and</span>
<span class="sd">        is used to create a global abstract entity. identityref is</span>
<span class="sd">        a pointer to the global entity.</span>

<span class="sd">        Where it gets tricky is the identity refers to a base and</span>
<span class="sd">        the base can be another base which then refers to another</span>
<span class="sd">        base and so on.  If you end up trying to configure an RPC,</span>
<span class="sd">        you need to have all the relevent information to form the</span>
<span class="sd">        XML tag.  The identity is sometimes defined in a different</span>
<span class="sd">        module than the identityref is defined.  That means you</span>
<span class="sd">        will need the namespace of that module.  The most notorious</span>
<span class="sd">        identity base is iana-interface-type defined iniana-if-type.</span>

<span class="sd">        Example RPC tag needed for ietf-interfaces module::</span>

<span class="sd">            &lt;type xmlns:ianaift=&quot;urn:ietf:params:xml:ns:yang:iana-if-type&quot;&gt;\</span>
<span class="sd">ianaift:ethernetCsmacd&lt;/type&gt;</span>

<span class="sd">        This functon will extract the namespace prefix, and base from</span>
<span class="sd">        the pyang.statements.Statement structure and construct a python dict.</span>
<span class="sd">        ::</span>

<span class="sd">            {moduleone: {base1: [identity1, identity2],</span>
<span class="sd">                         base2: [identity3, identity4]},</span>
<span class="sd">             moduletwo: {base3: [identity5, identity6],</span>
<span class="sd">                         base4: [identity7, identity8]}}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_status</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Checking identity bases...&quot;</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;i_identities&#39;</span><span class="p">):</span>
                <span class="n">bases</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">pfx</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">i_prefix</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">arg</span>
                <span class="n">ref_mods</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># Collect identityrefs from all modules first</span>
                <span class="k">for</span> <span class="n">idt_stmt</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">i_identities</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">idt</span> <span class="o">=</span> <span class="n">idt_stmt</span><span class="o">.</span><span class="n">arg</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="n">idt_stmt</span><span class="o">.</span><span class="n">search_one</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">:</span>
                        <span class="c1"># No base so this is an identity not identityref</span>
                        <span class="k">continue</span>

                    <span class="k">while</span> <span class="n">base</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">i_identity</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="c1"># Could be base of a base of a base etc...</span>
                        <span class="c1"># Find the real base</span>
                        <span class="n">bref</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">i_identity</span><span class="o">.</span><span class="n">search_one</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bref</span><span class="p">:</span>
                            <span class="c1"># The base may already be in list of identityrefs.</span>
                            <span class="c1"># This happens so infrequent, instead of looping</span>
                            <span class="c1"># through all possible identities to find them</span>
                            <span class="c1"># ahead of time, just remove them from the list.</span>
                            <span class="n">base_idt</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">i_module</span><span class="o">.</span><span class="n">i_prefix</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">base</span><span class="o">.</span><span class="n">arg</span>
                            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">bases</span> <span class="ow">in</span> <span class="n">ref_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">idts</span> <span class="ow">in</span> <span class="n">bases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">base_idt</span> <span class="ow">in</span> <span class="n">idts</span><span class="p">:</span>
                                        <span class="n">idts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">base_idt</span><span class="p">)</span>
                            <span class="n">base</span> <span class="o">=</span> <span class="n">bref</span>
                            <span class="k">continue</span>
                        <span class="k">break</span>

                    <span class="n">base_idt</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">arg</span>
                    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">arg</span><span class="p">:</span>
                        <span class="n">base_pfx</span><span class="p">,</span> <span class="n">base_idt</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">base_pfx</span> <span class="o">!=</span> <span class="n">idt_stmt</span><span class="o">.</span><span class="n">i_module</span><span class="o">.</span><span class="n">i_prefix</span><span class="p">:</span>
                            <span class="c1"># base is in another module</span>
                            <span class="n">mod</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">i_prefixes</span><span class="p">[</span><span class="n">base_pfx</span><span class="p">]</span>

                    <span class="n">idt</span> <span class="o">=</span> <span class="n">pfx</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">idt</span>

                    <span class="k">if</span> <span class="n">mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ref_mods</span><span class="p">:</span>
                        <span class="n">new_idt</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="n">new_idt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idt</span><span class="p">)</span>
                        <span class="n">ref_mods</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">base_idt</span><span class="p">:</span> <span class="n">new_idt</span><span class="p">}</span>
                    <span class="k">elif</span> <span class="n">base_idt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ref_mods</span><span class="p">[</span><span class="n">mod</span><span class="p">]:</span>
                        <span class="n">new_idt</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="n">new_idt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idt</span><span class="p">)</span>
                        <span class="n">ref_mods</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="n">base_idt</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_idt</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Identity could have been removed earlier</span>
                        <span class="n">ref_mods</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="n">base_idt</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idt</span><span class="p">)</span>

                <span class="c1"># Add refs to existing ones</span>
                <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">bases</span> <span class="ow">in</span> <span class="n">ref_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identities</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">idts</span> <span class="ow">in</span> <span class="n">bases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identities</span><span class="p">[</span><span class="n">mod</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">identities</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">idts</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">identities</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="n">base</span><span class="p">]</span> <span class="o">=</span> <span class="n">idts</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">identities</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">bases</span></div>

    <span class="n">VALIDATE_RESULT_TEMPLATE</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;revision&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;found&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;usable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">PYANG_ERROR_LEVELS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;CRITICAL ERROR&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;MAJOR ERROR&#39;</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;MINOR ERROR&#39;</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="YSContext.validate"><a class="viewcode-back" href="../../developer/ysyangtree.context.html#ysyangtree.context.YSContext.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate our loaded modules and report on the results.</span>

<span class="sd">        This function returns a list of dicts, where each dict represents</span>
<span class="sd">        the results of validating a single schema in the given path.</span>
<span class="sd">        We return this structure, instead of a dict of dicts, because in</span>
<span class="sd">        the future we may provide an iterative API. This API would allow us</span>
<span class="sd">        to report results for each schema as it is loaded and validated</span>
<span class="sd">        instead of as one monolithic block at the end.</span>

<span class="sd">        Each dict has the following structure::</span>

<span class="sd">            {</span>
<span class="sd">                name: &#39;ietf-interfaces&#39;,</span>
<span class="sd">                revision: &#39;2014-05-08&#39;,</span>
<span class="sd">                found: True,</span>
<span class="sd">                usable: True,</span>
<span class="sd">                errors: [&#39;error message&#39;, &#39;error message two&#39;],</span>
<span class="sd">                warnings: None,</span>
<span class="sd">            }</span>

<span class="sd">        In case of a global error (such as invalid parameters passed to this</span>
<span class="sd">        function), the only entry will have empty name and revision strings.</span>

<span class="sd">        If a module is available in the yangset, &#39;found&#39; will be True.</span>
<span class="sd">        If so, then if the module could be loaded, despite any errors</span>
<span class="sd">        or warnings, then the &#39;usable&#39; key will also be True.</span>
<span class="sd">        Otherwise these keys will be False.</span>

<span class="sd">        Returns:</span>
<span class="sd">          list: List of dicts, each describing a schema and its result.</span>
<span class="sd">          Sorted by module name and then by revision.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Dict of name -&gt; revision -&gt; results</span>
        <span class="c1"># Before we&#39;re done, we&#39;ll transform this into a flat list of results</span>
        <span class="n">schemas</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

        <span class="c1"># self.modules has the set of modules that were parsed at least</span>
        <span class="c1"># somewhat successfully, while self.invalid_modules has the names</span>
        <span class="c1"># that failed parsing and aborted.</span>
        <span class="c1"># self.errors includes errors for missing dependencies - include those</span>
        <span class="c1"># Note that our repository may have multiple sources for a given</span>
        <span class="c1"># module.</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_modules_and_revisions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid_modules</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">]:</span>
                    <span class="c1"># We shouldn&#39;t encounter this case</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Multiple sources exist for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">))</span>
                    <span class="c1"># Take the best &#39;usable&#39; value</span>
                    <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="s1">&#39;usable&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="s1">&#39;usable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
                <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Since we load all available modules at present (TODO!),</span>
                <span class="c1"># a module that neither loaded successfully nor failed to load</span>
                <span class="c1"># is an indication something is wrong.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Module </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> appears not to have been parsed &quot;</span>
                          <span class="s2">&quot;despite being a member of repository </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">epos</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">error</span>
            <span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;MODULE_NOT_FOUND&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">rev</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">elif</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;MODULE_NOT_FOUND_REV&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">rev</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">]</span> <span class="ow">and</span> <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got a &quot;</span><span class="si">%s</span><span class="s1">&quot; error for (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) but already have a&#39;</span>
                          <span class="s1">&#39; previous &quot;found&quot; entry: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">name</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">])</span>
            <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="s1">&#39;usable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Each entry in self.errors consists of:</span>
        <span class="c1"># 1) a pyang.error.Position object specifying where the error happened</span>
        <span class="c1"># 2) a string tag representing the error type</span>
        <span class="c1"># 3) A tuple of additional args associated with this error</span>
        <span class="c1">#</span>
        <span class="c1"># Here we remap flat list of self.errors into a dict[dict[dict[list]]],</span>
        <span class="c1"># indexed by module name, then by revision, then by line number.</span>
        <span class="c1"># Each entry is a list because one line can report several errors.</span>
        <span class="n">ctx_errors</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)))</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">get_base_path</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">epos</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">error</span>

            <span class="c1"># Within the Position, epos.ref gives the file path, but what we</span>
            <span class="c1"># prefer is the module name being parsed, which is in epos.top.arg.</span>
            <span class="c1"># For certain egregious errors this may not be available, in which</span>
            <span class="c1"># case we can fall back to guessing the module from the filename.</span>
            <span class="c1">#</span>
            <span class="c1"># The Position never directly states the revision, so, if we are</span>
            <span class="c1"># lucky enough to only have one revision for this module,</span>
            <span class="c1"># we use that, otherwise we just guess it from the filename.</span>

            <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">revision</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">epos</span><span class="o">.</span><span class="n">top</span> <span class="ow">and</span> <span class="n">epos</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">arg</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">epos</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">arg</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">revision</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">revision</span><span class="p">:</span>
                <span class="n">_name</span><span class="p">,</span> <span class="n">_revision</span> <span class="o">=</span> <span class="n">name_and_revision_from_file</span><span class="p">(</span>
                    <span class="n">epos</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">assume_correct_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c1"># Either pyang couldn&#39;t determine the name, or the name</span>
                    <span class="c1"># that pyang determined was different than the name that</span>
                    <span class="c1"># our repository thinks. Either way, fall back to the</span>
                    <span class="c1"># module name guessed by quickparser.</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">_name</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">revision</span><span class="p">:</span>
                    <span class="n">revision</span> <span class="o">=</span> <span class="n">_revision</span>

            <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="c1"># Don&#39;t leak information about the system base path</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
                             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">arg</span>
                             <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">epos</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">pyang_err</span><span class="o">.</span><span class="n">err_level</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">err_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{tag}</span><span class="s2"> line </span><span class="si">{line}</span><span class="s2">: </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PYANG_ERROR_LEVELS</span><span class="p">[</span><span class="n">level</span><span class="p">],</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">=</span><span class="n">pyang_err</span><span class="o">.</span><span class="n">err_to_str</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
            <span class="n">ctx_errors</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">revision</span><span class="p">][</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">level</span><span class="p">,</span> <span class="n">err_string</span><span class="p">])</span>

        <span class="c1"># Successful schemas won&#39;t appear in ctx_errors, but if we have errors</span>
        <span class="c1"># for modules or revisions we don&#39;t know of, we need to report on that!</span>
        <span class="n">missing_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctx_errors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">schemas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">missing_schemas</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;pyang reported errors for the following modules &quot;</span>
                        <span class="s2">&quot;that were not known to our repository: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">missing_schemas</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ctx_errors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">missing_revisions</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctx_errors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span>
                                 <span class="nb">set</span><span class="p">(</span><span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">missing_revisions</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;pyang reported errors for revisions of module </span><span class="si">%s</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;that were not known to our repository: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">missing_revisions</span><span class="p">)</span>

        <span class="c1"># Now, use the schemas plus the errors to construct the result list</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">schemas</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">rev</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">schemas</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALIDATE_RESULT_TEMPLATE</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rev</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;usable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;usable&#39;</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;found&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ctx_errors</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">err_string</span> <span class="ow">in</span> <span class="n">ctx_errors</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">rev</span><span class="p">][</span><span class="n">line</span><span class="p">]:</span>
                        <span class="c1"># How severe of an issue is this?</span>
                        <span class="c1"># Pyang defines levels 1 through 4 from CRITICAL ERROR</span>
                        <span class="c1"># down to WARNING - we map the first two levels as</span>
                        <span class="c1"># &#39;errors&#39; and the latter two as &#39;warnings&#39;</span>
                        <span class="c1"># in our result structure</span>
                        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_string</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_string</span><span class="p">)</span>

                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, YANG Suite development team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.19.1.post0.dev3',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>